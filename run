#!/usr/bin/env bash
set -euo pipefail

NUM_SERVERS=3
TESTENV=(sudo -n tools/testenv/testenv.sh)

sudo -v || { echo "need sudo"; exit 1; }

logrun() {
  local label=$1
  shift
  stdbuf -oL "$@" 2>&1 | sed "s/^/[$label] /"
}

bg_pids=()
logrun_bg() {
  local label=$1
  shift
  stdbuf -oL "$@" 2>&1 | tee >(sed "s/^/[$label] /") >/dev/null &
  bg_pids+=($!)
}

cleanup() {
  for pid in "${bg_pids[@]}"; do
    kill "$pid" 2>/dev/null || true
    wait "$pid" 2>/dev/null || true
  done
}

trap cleanup EXIT SIGINT SIGTERM

usage() {
  echo "Usage: $0 [-s NUM_SERVERS]" >&2
  exit 1
}

# parse args
while getopts "s:" opt; do
  case $opt in
    s) NUM_SERVERS=$OPTARG ;;
    *) usage ;;
  esac
done

export RUST_LOG=info

# 1. build
cargo build --release

# 2. setup testenvs
# veth devices won't deliver redirected/retransmitted XDP frames unless an XDP program is attached to the receiving side of the target veth interface
for i in $(seq 1 "$NUM_SERVERS"); do
  env="server$i"

  "${TESTENV[@]}" setup --name "$env" --legacy-ip >/dev/null 2>&1 || true

  logrun_bg "$env" "${TESTENV[@]}" exec -n "$env" -- \
    bash -c "RUST_LOG=info target/release/xdp-pass --iface veth0"
done

"${TESTENV[@]}" setup --name writer --legacy-ip >/dev/null 2>&1 || true

logrun_bg "writer" "${TESTENV[@]}" exec -n writer -- \
  bash -c "RUST_LOG=info target/release/xdp-pass --iface veth0"

# 3. run the servers
for i in $(seq 1 "$NUM_SERVERS"); do
  env="server$i"

  logrun_bg "$env" sudo -E target/release/abd-server \
    --iface "$env" --num-servers="$NUM_SERVERS" --server-id "$i"
done

# 4. run the writer
logrun_bg "writer" sudo -E target/release/abd-writer \
  --iface writer --num-servers="$NUM_SERVERS" \

# 4. wait a moment
sleep 1

# 5. run the client
echo
writer_ip=$(
  "${TESTENV[@]}" -n writer status \
    | awk '/Iface:/ {print $4}' \
    | cut -d'/' -f1
)
writer_sender_id=0
logrun "client" "${TESTENV[@]}" exec -n writer -- bash -c "
  target/release/abd-client $writer_ip $writer_sender_id write 1 42 1 &&
  target/release/abd-client $writer_ip $writer_sender_id read 2
"
